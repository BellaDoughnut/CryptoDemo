<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vote Page</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: rgba(255,255,255,0.6);
      background-blend-mode: lighten;
      background-repeat: no-repeat;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
      white-space: pre-line;
      font-size: 2rem;
    }

    #choice-container {
      display: flex;
      flex: 1;
    }

    .choice {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .choice img {
      max-width: 100%;
      max-height: 100%;
      transition: 0.3s;
    }

    .choice:hover img {
      transform: scale(1.05);
      filter: brightness(1.1);
    }

    #result {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      font-size: 1.2rem;
    }

    #qr {
      margin-top: 20px;
    }

    #img1 {
      height: 300px;
      object-fit: cover;
      object-position: 100% 0%;}

    #img-1 {
      height: 300px;
      object-fit: cover;
      object-position: 0% 0%;
    }
  </style>
</head>
<body>
  <h1>WHICH ONE FOR</br> YOUR SKI TRIP?</h1>
  <h2>Click on the picture to vote</h2>
  <h2>DAVOS or AROSA?</h2>

  <div id="choice-container">
    <div class="choice" id="select1" onclick="submitVote(1)">
      <img id="img1" src="davos2.jpg" alt="Option 1" />
    </div>
    <div class="choice" id="select2" onclick="submitVote(-1)">
      <img id="img-1" src="Arosa.jpg" alt="Option 2" />
    </div>
  </div>

  <div id="result">
    <p id="message"></p>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdpldLVoFbnBQU_s-AYeOUFZOMn5Q-VC9JiT2m5m79BHsHPSg/viewform?usp=dialog"><img id="qr"></img></a>
  </div>

  <script>
    //Parameters for Pallier
    const p = 383n, q = 467n;
    const N  = p*q; //178861
    const g = N+1n; //178862
    const N2 = N * N; //31991257321
    const lambda = lcm(p-1n,q-1n); //89006

    const u=modPow(g,lambda,N2); //15919702167
    const L_u = (u - 1n) / N; //89006
    const mu = modInv(L_u,N); //131249

    //Test alert
    //alert("p="+p+",q="+q+",N="+N+",N2="+N2+",g="+g+",lambda="+lambda+",u="+u+",mu="+mu+",L_u="+L_u)

    function CalcCiphertext(choice) {
      if(choice<0){
        choice = N-1n;
      }
      const r = BigInt(Math.floor(2 + Math.random() * (Number(N)-2)));
      const m = modPow(choice,1n,N);
      //alert(m);
      const gm = modPow(g, m, N2);
      const rN = modPow(r, N, N2);
      return (gm * rN) % N2;

    }

    function paillierDecrypt(c) {
      // u = c^λ mod n^2
      const u2 = modPow(c, lambda, N2);
      // m = L(u) * μ mod n
      const lu = L(u2);
      return (lu * mu) % N;
    }

    function submitVote(choice) {
      const ciphertext = CalcCiphertext(BigInt(choice));

      var body = document.getElementsByTagName('body')[0];
      body.style.backgroundImage = "url("+document.getElementById('img'+choice).src+")";
      body.style.backgroundSize = "100% auto";


      document.getElementById('choice-container').style.display = 'none';
      const msg = document.getElementById('message');
      msg.innerHTML =
        "Thank you for the vote.<br/> here's your vote ciphertext:<br/><br/>"+
        "<input type='text' size='35' value="+ ciphertext +"></input>"+
        "<br/><br/>Please paste the ciphertext in the following form to cast your vote";

      document.getElementById('result').style.display = 'flex';
      generateQR();
    }

    // Show the QR code
    function generateQR() {
      const img = document.getElementById("qr");
      img.src = "url.png";
      img.alt = "QR Code";
      img.width = "200"
      img.style.marginTop = "20px";

    }

    //functions for math calculation
    function egcd(a, b) {
      if (b === 0n) return [1n, 0n, a];
      const [x1, y1, g] = egcd(b, a % b);
      return [y1, x1 - (a / b) * y1, g];
    }

    function modInv(a, m) {
      const [x, , g] = egcd(a % m + m, m);
      if (g !== 1n) return null;
      return (x % m + m) % m;
    }

    function gcd(a, b) {
      a = a < 0n ? -a : a;
      b = b < 0n ? -b : b;
      while (b !== 0n) {
        const t = a % b;
        a = b;
        b = t;
      }
      return a;
    }

    function lcm(a, b) {
      return (a / gcd(a, b)) * b;
    }

    function modPow(base, exp, mod) {
      base = base % mod;
      let result = 1n;
      while (exp > 0n) {
        if (exp & 1n) result = (result * base) % mod;
        base = (base * base) % mod;
        exp >>= 1n;
      }
      return result;
    }

    function L(u) {
    return (u - 1n) / N;
    }
  </script>
</body>
</html>
