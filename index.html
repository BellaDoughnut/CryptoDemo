<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vote Page</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: rgba(255,255,255,0.9);
      background-position:center;
      background-image:url(MScAdvancedCybersecurity_Banner.png);
      background-blend-mode: lighten;
      background-repeat: no-repeat;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
      white-space: pre-line;
      font-size: 2rem;
    }

    #choice-container {
      background: rgba(255,255,255,0.7);
      display: flex;
      flex-direction: column;      
      justify-content: center;     
      align-items: center;         
      height: 100vh;
    }

    .choice {
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      margin: 10px 0;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .choice img {
      max-width: 100%;
      max-height: 100%;
      transition: 0.3s;
    }

    .choice:hover img {
      transform: scale(1.05);
      filter: brightness(1.1);
    }

    #result {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      font-size: 1.2rem;
    }

    #qr {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>WHICH PRESENTATION</br> DO YOU PICK?</h1>
  <h2>Tick at most 2 checkboxes to vote</h2>

  <div id="choice-container">
    <div class="choice" id="group1">
      <input type="checkbox" id="choice1" value="1">
        <label for="choice1"> Topic 1: E-voting </label><br>
    </div><br>
    <div class="choice" id="group2">
      <input type="checkbox" id="choice2" value="2">
        <label for="choice2"> Topic 2: Perceptual Hashing </label><br>
    </div><br>
    <div class="choice" id="group3">
      <input type="checkbox" id="choice3" value="3">
        <label for="choice3"> Topic 7: Hacking of Electric Vehicles </label><br>
    </div> <br>
    <div class="choice" id="group4">
      <input type="checkbox" id="choice4" value="4">
        <label for="choice4"> Topic 8: End-to-end Messaging </label><br>
    </div> <br>
    <div class="choice" id="group5">
      <input type="checkbox" id="choice5" value="5">
        <label for="choice5"> Topic 9: Security Risks of LLM Agents </label><br>
    </div> <br>
    <!--style="display: none;"-->
    <div class="choice" id="group6" >
      <input type="checkbox" id="choice6" value="6">
        <label for="choice6"> Topic 10: Quantum Key Exchange </label><br>
    </div> <br>
    <div class="vote" id="vote">
      <input type="button" id="voteit" onclick="submitVote()" value="Vote!">
    </div>
  </div>

  <div id="result">
    <p id="message"></p>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdpldLVoFbnBQU_s-AYeOUFZOMn5Q-VC9JiT2m5m79BHsHPSg/viewform?usp=dialog"><img id="qr"></img></a>
  </div>

  <script>
    //Parameters for Pallier
    //const p = 383n, q = 467n; //highschool demo 10/12/2025
    //const p = 164987n, q = 110459n; // 11/12/2025 master's demo
    const p=1001723n,q=1001459n; // 18/12/2025 master's demo
    const N  = p*q; //N=1003184513857
    const g = N+1n; //g=1003184513858
    const N2 = N * N; //N2=1006379168842505425016449
    const lambda = lcm(p-1n,q-1n); //lambda=501591255338


    const u=modPow(g,lambda,N2); //503188579641173886218667
    const L_u = (u - 1n) / N; //501591255338
    const mu = modInv(L_u,N); //597534955445

    //Test
    //console.log("p="+p+",q="+q+",N="+N+",N2="+N2+",g="+g+",lambda="+lambda+",u="+u+",mu="+mu+",L_u="+L_u)
    //p=1001723,q=1001459,N=1003184513857,N2=1006379168842505425016449,g=1003184513858,lambda=501591255338,u=503188579641173886218667,mu=597534955445,L_u=501591255338

    function CalcCiphertext(choice) {
      const r = BigInt(Math.floor(2 + Math.random() * (Number(N)-2)));
      const m = modPow(choice,1n,N);
      //alert(m);
      const gm = modPow(g, m, N2);
      const rN = modPow(r, N, N2);
      return (gm * rN) % N2;
    }

    function paillierDecrypt(c) {
      // u = c^λ mod n^2
      const u2 = modPow(c, lambda, N2);
      // m = L(u) * μ mod n
      const lu = L(u2);
      return (lu * mu) % N;
    }
    //
    function submitVote() {
      const boxes = document.querySelectorAll(".choice");
      var choice = 0n;

      // Count how many are checked
      var checkedCount = 0;
      for (let i=1;i<7;i++){
        const box = document.getElementById("choice"+i);
        if (box.checked) {
            checkedCount++;
            exp = 2n * BigInt(box.value -1);
            choice = choice + 10n ** exp;
        }
      }
      //alert(choice);

      // If more than 2 checked → do something
      if (checkedCount > 2) {
          alert("More than 2 choices checked!");
      } else if (checkedCount < 1){
          alert("Choose something pleeeease.");
      } else {
          const ciphertext = CalcCiphertext(BigInt(choice));

          //var body = document.getElementsByTagName('body')[0];
          //body.style.backgroundImage = "url("+document.getElementById('img'+choice).src+")";
          //body.style.backgroundSize = "100% auto";


          document.getElementById('choice-container').style.display = 'none';
          const msg = document.getElementById('message');
          msg.innerHTML =
            "Thank you for the vote.<br/> here's your vote ciphertext:<br/><br/>"+
            "<input type='text' size='35' value="+ ciphertext +"></input>"+
            "<br/><br/>Please paste the ciphertext in the following form to cast your vote";

          document.getElementById('result').style.display = 'flex';
          generateQR();
      }
      
    }

    // Show the QR code
    function generateQR() {
      const img = document.getElementById("qr");
      img.src = "url.png";
      img.alt = "QR Code";
      img.width = "200"
      img.style.marginTop = "20px";

    }

    //functions for math calculation
    function egcd(a, b) {
      if (b === 0n) return [1n, 0n, a];
      const [x1, y1, g] = egcd(b, a % b);
      return [y1, x1 - (a / b) * y1, g];
    }

    function modInv(a, m) {
      const [x, , g] = egcd(a % m + m, m);
      if (g !== 1n) return null;
      return (x % m + m) % m;
    }

    function gcd(a, b) {
      a = a < 0n ? -a : a;
      b = b < 0n ? -b : b;
      while (b !== 0n) {
        const t = a % b;
        a = b;
        b = t;
      }
      return a;
    }

    function lcm(a, b) {
      return (a / gcd(a, b)) * b;
    }

    function modPow(base, exp, mod) {
      base = base % mod;
      let result = 1n;
      while (exp > 0n) {
        if (exp & 1n) result = (result * base) % mod;
        base = (base * base) % mod;
        exp >>= 1n;
      }
      return result;
    }

    function L(u) {
    return (u - 1n) / N;
    }
  </script>
</body>
</html>
